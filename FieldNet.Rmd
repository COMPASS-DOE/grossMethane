---
title: "FieldNet"
author: "Kendalynn A. Morris"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_depth: '2'
    toc_float: yes
---

```{r setup, include=FALSE}
#load packages
library(dplyr)
library(lubridate)
library(ggplot2)
library(ggpmisc)

theme_set(theme_minimal() + theme(text = element_text(size = 11)))

# 'Pretty n' function to round a numeric value and print that # of digits
pn <- function(x, n) {
  formatC(round(unlist(x), n),
          digits = n, format = "f")
}

# 'Clean p value' function to pretty-print p value(s), specifically
pclean <- function(x, digits = 3, printP = TRUE) {
  x <- as.vector(x)
  ltstring <- paste0("< 0.", paste(rep("0", digits - 1), 
                                   collapse = ""), "1")
  valstring <- ifelse(x < 10 ^ -digits, 
                      ltstring, pn(x, digits))
  if(printP) {
    paste("P", ifelse(x < 10 ^ -digits, 
                      valstring, paste("=", valstring)))
  } else {
    valstring
  }
}
```

Here are the field net-rate data and their analysis for the surface-flux portion of Morris et al 2023b. Fluxes are calculated using SoilFluxPro, data was collected using a LI-7810 equipped with a soil moisture probe.  

# Data Summary

```{r Read & Summarize Data, echo = FALSE, message = TRUE}
f_dat <- read.csv("field-measurements/licorRTA.csv")
f_dat$date <- as_date(f_dat$date, "%m/%d/%Y", tz="EST")
f_dat$timestamp <- mdy_hm(f_dat$timestamp, tz="EST")
f_dat$Collar <- as.factor(f_dat$Collar)

summary(f_dat)
```

# Normalize

```{r normalization of field data, include = FALSE}

#CH4
range(f_dat$FCH4)
hist(log10(f_dat$FCH4 + 12))
f_dat$nFCH4 <- log10(f_dat$FCH4 +12)

#CO2
range(f_dat$FCO2)
hist(log10(f_dat$FCO2))
f_dat$nFCO2 <- log10(f_dat$FCO2)

#SWC
is.na(f_dat$SWC) <- !f_dat$SWC
hist(f_dat$SWC)

#select T4 as the representative flux for all analyses. Justification: at the end of the incubation head space gas composition will most closely resemble the atmosphere.
labDat %>%
  filter(round == "T4") -> grossFlux

hist(grossFlux$sm)
hist(grossFlux$P_rate)
hist(grossFlux$C_rate)

require(rcompanion)
transformTukey(grossFlux$P_rate,
               plotit = TRUE, verbose = TRUE)
transformTukey(grossFlux$C_rate,
               plotit = TRUE, verbose = TRUE)

hist(grossFlux$P_rate^0.025)
hist(-1 * grossFlux$C_rate^-0.075)
```

Soil samples come from 5 different origins (lowland, upland, midslope, upstream, and midstream) and are situated in two physical locations (lowland, upland). Does soil origin, current location, or an interaction between the two explain variation in gross methane production or consumption?  

## Production 

```{r production, message = FALSE, warning = FALSE}
require(car)
P_transplant <- aov(P_rate^0.025 ~ Location*Origin,
                  data = grossFlux)
Anova(P_transplant)
Ptrans <- unlist(Anova(P_transplant))
Ptrans_loc <- Ptrans["Pr(>F)1"]

P_moisture <- aov(P_rate^0.025 ~ sm,
                  data = grossFlux)
Anova(P_moisture)
Pmois <- unlist(Anova(P_moisture))
Pmois_sm <- Pmois["Pr(>F)1"]
```

There is evidence that location influences methane production (`r pclean(Ptrans_loc, 3)`), and equal evidence that soil moisture does (`r pclean(Pmois_sm, 3)`).  

## Consumption

```{r consumption, message = FALSE, warning = FALSE}
require(car)
C_transplant <- aov(-1 * C_rate^-0.075 ~ Location*Origin,
                  data = grossFlux)
Anova(C_transplant)
Ctrans <- unlist(Anova(C_transplant))
Ctrans_loc <- Ctrans["Pr(>F)1"]

C_moisture <- aov(C_rate ~ sm,
                  data = grossFlux)
Anova(C_moisture)
Cmois <- unlist(Anova(C_moisture))
Cmois_sm <- Cmois["Pr(>F)1"]
```

There's strong evidence that location influences methane consumption (`r pclean(Ctrans_loc, 3)`), and even stronger evidence that soil moisture does (`r pclean(Cmois_sm, 3)`).  

## Soil Moisture

```{r moisture, message = FALSE, warning = FALSE}
require(car)
sm_transplant <- aov(sm ~ Location*Origin,
                  data = grossFlux)
Anova(sm_transplant)
Mois <- unlist(Anova(sm_transplant))
Mois_loc <- Mois["Pr(>F)1"]
```

Location strongly influences soil moisture values (`r pclean(Mois_loc, 3)`), which have a clear influence on both gross methane fluxes. In order to directly test the influence of soil origin, we separate the two locations and assess soil-origin without the interaction of current location.  

# Origin Effects

```{r Origin Within Upland, echo = FALSE, include = FALSE}
grossFlux %>%
  filter(Location == "g_up") -> UpFlux

hist(UpFlux$sm)
hist(UpFlux$P_rate)
hist(UpFlux$C_rate)

transformTukey(UpFlux$P_rate,
               plotit = TRUE, verbose = TRUE)
transformTukey(UpFlux$C_rate,
               plotit = TRUE, verbose = TRUE)

hist(UpFlux$P_rate^0.025)
hist(-1 * UpFlux$C_rate^-0.725)

#soil origin
#production
upP_transplant <- aov(P_rate^0.025 ~ Origin,
                  data = UpFlux)
Anova(upP_transplant)
upPt <- unlist(Anova(upP_transplant))
UpP_trans <- upPt["Pr(>F)1"]

#consumption
upC_transplant <- aov(-1 * C_rate^-0.725 ~ Origin,
                  data = UpFlux)
Anova(upC_transplant)
upCt <- unlist(Anova(upC_transplant))
UpC_trans <- upCt["Pr(>F)1"]
```

## Upland  

We find no evidence that soil origin influences gross methane production or consumption in the upland (`r pclean(c(UpP_trans, UpC_trans), 3)`).

```{r Origin on Moisture in Upland, echo = FALSE, include = FALSE}
upP_moisture <- aov(P_rate^0.025 ~ sm,
                  data = UpFlux)
Anova(upP_moisture)

upC_moisture <- aov(-1 * C_rate^-0.725 ~ sm,
                  data = UpFlux)
Anova(upC_moisture)
upCm <- unlist(Anova(upC_moisture))
UpC_mois <- upCm["Pr(>F)1"]
```

Rather the variation that is present in gross consumption is best explained by soil moisture (`r pclean(UpC_mois, 3)`). 

## Lowland  

```{r Origin Within Lowland, echo = FALSE, include = FALSE}
grossFlux %>%
  filter(Location == "g_low") -> LowFlux

hist(LowFlux$sm)
hist(LowFlux$P_rate)
hist(LowFlux$C_rate)

transformTukey(LowFlux$P_rate,
               plotit = TRUE, verbose = TRUE)
transformTukey(LowFlux$C_rate,
               plotit = TRUE, verbose = TRUE)

hist(-1 * LowFlux$P_rate^-0.325)
hist(-1 * LowFlux$C_rate^-0.025)

#soil origin
#production
LowP_transplant <- aov(-1* P_rate^0.325 ~ Origin,
                  data = LowFlux)
Anova(LowP_transplant)
lowP_trans <- unlist(Anova(LowP_transplant))
lowPt <- lowP_trans["Pr(>F)1"]

#consumption
LowC_transplant <- aov(-1 * C_rate^-0.025 ~ Origin,
                  data = LowFlux)
Anova(LowC_transplant)
lowC_trans <- unlist(Anova(LowC_transplant))
lowCt <- lowC_trans["Pr(>F)1"]
```

Similarly, there is no evidence that soil origin influences gross methane production or consumption in the lowland (`r pclean(c(lowPt, lowCt), 3)`).  

```{r Origin on Moisture in Lowland, echo = FALSE, include = FALSE}
LowP_moisture <- aov(-1* P_rate^0.325 ~ sm,
                  data = LowFlux)
Anova(LowP_moisture)

LowC_moisture <- aov(-1 * C_rate^-0.025 ~ sm,
                  data = LowFlux)
Anova(LowC_moisture)
lowCm <- unlist(Anova(LowC_moisture))
lowC_mois <- lowCm["Pr(>F)1"]
```

Instead, the variation that is present in gross consumption is best explained by soil moisture (`r pclean(lowC_mois, 3)`).

# Summary Plot of Gross Rates

```{r Summary Graph of Analytes, echo = FALSE, warning = FALSE}
#summary of production
Olabs <- c("lowland", "midslope", "upland", "midstream", "upstream")
Llabs <- c("lowland", "upland")
labellies <- c('g_low' = "lowland",
               'g_mid' = "midslope",
               'g_up' = "upland",
               'midstream' = "midstream",
               'upstream' = "upstream")
grossFlux %>%
  select(Location, Origin, P_rate, C_rate, sm) %>%
  pivot_longer(P_rate:sm, names_to = "vars") %>%
ggplot(., aes(Location, value, fill = Origin)) +
    scale_x_discrete(labels = c("lowland",
                                "upland")) +
    scale_fill_discrete(labels = Olabs) +
    geom_boxplot() + facet_wrap(.~vars, scales = "free")

```

# Distribution of Gross Rates

```{r net of gross, echo = FALSE, warning = FALSE}
grossFlux$diff <- grossFlux$P_rate - grossFlux$C_rate

ggplot(grossFlux, aes(diff, fill = Location)) +
  scale_fill_discrete(labels = Llabs) +
  xlab("Net Rate") +
  geom_histogram(binwidth = 0.5, color = "black")

```

# Linear Regressions with Soil Moisture

```{r Consumption vs SM, echo = FALSE, warning = FALSE}
library(latex2exp)

ggplot(grossFlux, aes(sm, C_rate)) +
  geom_point(aes(color = Location, shape = Location), size = 3) +
  scale_color_manual(values = c("#FF33CC", "#00CC66"),
                     labels = Llabs) +
  scale_shape_discrete(labels = Llabs) +
    geom_smooth(method = lm, formula = y ~ x, se = FALSE, size = 0.5) +
  labs(x=  unname(TeX("\n Soil Moisture $(g * g^{-1})$")),
       y= unname(TeX("\n Consumption $(\\mu mol * g^{-1} * d^{-1})$"))) +
    stat_poly_eq(formula = y ~ x,
                 aes(label = paste(..eq.label..,
                                   ..rr.label..,
                                   sep = "~~~"))) +
  theme_bw(base_size = 15) +
  theme(plot.margin = margin(t = 20, r = 20, b = 20, l = 20))
```

```{r Production vs SM, echo = FALSE, warning = FALSE}
ggplot(grossFlux, aes(sm, P_rate)) +
  geom_point(aes(color = Location, shape = Location), size = 3) +
  scale_color_manual(values = c("#FF33CC", "#00CC66"),
                     labels = Llabs) +
  scale_shape_discrete(labels = Llabs) +
    geom_smooth(method = lm, formula = y ~ x, se = FALSE, size = 0.5) +
  labs(x=  unname(TeX("\n Soil Moisture $(g * g^{-1})$")),
       y= unname(TeX("\n Production $(\\mu mol * g^{-1} * d^{-1})$"))) +
    stat_poly_eq(formula = y ~ x,
                 aes(label = paste(..eq.label..,
                                   ..rr.label..,
                                   sep = "~~~"))) +
  theme_bw(base_size = 15) +
  theme(plot.margin = margin(t = 20, r = 20, b = 20, l = 20))
```
