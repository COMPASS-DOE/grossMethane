---
title: "FieldNet"
author: "Kendalynn A. Morris"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_depth: '2'
    toc_float: yes
---

```{r setup, include=FALSE}
#load packages
library(dplyr)
library(lubridate)
library(ggplot2)
library(ggpmisc)
select <- dplyr::select

theme_set(theme_minimal() + theme(text = element_text(size = 11)))

# 'Pretty n' function to round a numeric value and print that # of digits
pn <- function(x, n) {
  formatC(round(unlist(x), n),
          digits = n, format = "f")
}

# 'Clean p value' function to pretty-print p value(s), specifically
pclean <- function(x, digits = 3, printP = TRUE) {
  x <- as.vector(x)
  ltstring <- paste0("< 0.", paste(rep("0", digits - 1), 
                                   collapse = ""), "1")
  valstring <- ifelse(x < 10 ^ -digits, 
                      ltstring, pn(x, digits))
  if(printP) {
    paste("P", ifelse(x < 10 ^ -digits, 
                      valstring, paste("=", valstring)))
  } else {
    valstring
  }
}
```

Here are the field net-rate data and their analysis for the surface-flux portion of Morris et al 2023b. Fluxes are calculated using SoilFluxPro, data was collected using a LI-7810 equipped with a soil moisture probe.  

# Data Summary

```{r Read & Summarize Data, echo = FALSE, warning = FALSE, message = TRUE}
f_dat <- read.csv("field-measurements/licorRTA.csv")
f_dat$date <- as_date(f_dat$date, "%m/%d/%Y", tz="EST")
f_dat$timestamp <- mdy_hm(f_dat$timestamp, tz="EST")
f_dat$Collar <- as.factor(f_dat$Collar)

summary(f_dat)
```

# Normalize

```{r normalization of field data, include = FALSE}

#CH4
range(f_dat$FCH4)
hist(log10(f_dat$FCH4 + 12))
f_dat$nFCH4 <- log10(f_dat$FCH4 +12)

#CO2
range(f_dat$FCO2)
hist(log10(f_dat$FCO2))
f_dat$nFCO2 <- log10(f_dat$FCO2)

#SWC
#cutting off values below 0.10,
#below this is almost certainly probe malfunction
f_dat$SWC <- replace(f_dat$SWC, f_dat$SWC < 0.10, NA)
hist(f_dat$SWC)


Olabs <- c("lowland", "midslope", "upland", "midstream", "upstream")
Llabs <- c("lowland", "midslope", "upland")
months <- c("May", "June", "July", "August")
```

Soil samples come from 5 different origins (lowland, upland, midslope, upstream, and midstream) and are situated in two physical locations (lowland, upland). Does soil origin, current location, or an interaction between the two explain variation in field measurements of CH4 or CO2 flux?  

## Methane

```{r Methane, message = FALSE, warning = FALSE}
methane <- aov(nFCH4 ~ Location*Origin + date + SWC + TS,
             data = f_dat)
summary(methane)
# par(mfrow=c(2,2))
# plot(methane)
# dev.off()
TukeyHSD(methane, which = "Location")
```

Initial analysis indicates a significant interaction between location and origin.  

```{r summary graph of methane, warning = FALSE, message = FALSE}
f_dat %>%
  filter(if_else(Location == "g_up", FCH4 < 300,
                 FCH4 < 2000)) -> filterM_f_dat

names(Llabs) = c("g_low", "g_mid", "g_up")

#interaction driven by lowland
ggplot(filterM_f_dat, aes(month(timestamp), FCH4, fill = Origin)) +
    geom_boxplot(aes(group = interaction(month(timestamp), Origin))) +
    scale_fill_discrete(name = "Soil Origin",
                      labels = Olabs) +
    labs(x = "Month", y = "Flux CH4",
         title = "Filtered Fluxes by Origin & Location") +
    facet_wrap(Location ~ ., scales = "free",
               labeller = labeller(Location = Llabs)) +
    theme_bw() + theme(legend.position = "bottom")

#Should some of these data points be filtered out of the analysis?
```

```{r Is interaction a true soil origin effect?}
#are midland origin soils the wettest?
SWC <- aov(SWC ~ Origin + date,
           data = f_dat[f_dat$Location == "g_low",])
summary(SWC)
TukeyHSD(SWC, which = "Origin")

#exclude g_mid
alt_low_meth <- aov(nFCH4 ~ Origin + date + SWC + TS,
                data = f_dat[f_dat$Location == "g_low" &
                                 f_dat$Origin != "g_mid",])
summary(alt_low_meth)
# par(mfrow=c(2,2))
# plot(alt_low_meth)
# dev.off()
TukeyHSD(alt_low_meth, which = "Origin")
#without midland soil, SWC content is the most important
```

Midland soils are the wettest in the lowland location, and when they are excluded the interaction term is no longer significant. There is no reason to believe that midland soils have inherently higher WHC than other soil origins (insert data on WHC here), therefore we attribute this effect to microtopography.

## Carbon Dioxide

```{r carbon dioxide, message = FALSE, warning = FALSE}
carbondioxide <- aov(nFCO2 ~ Location*Origin + date + SWC + TS,
             data = f_dat)
summary(carbondioxide)
# par(mfrow=c(2,2))
# plot(carbondioxide)
# dev.off()
TukeyHSD(carbondioxide, which = "Location")
```

All factors highly significant. Not helpful for understanding patterns.

```{r summary graph of respiration, warning = FALSE, message = FALSE}
f_dat %>%
  filter(FCO2 < 30,
         Origin %in% c("g_low", "g_mid", "g_up")) -> filterC_f_dat

#elevation transplant
ggplot(filterC_f_dat, aes(month(timestamp), FCO2, fill = Origin)) +
    geom_boxplot(aes(group = interaction(month(timestamp), Origin))) +
      scale_fill_discrete(name = "Soil Origin",
                      labels = Olabs) +
    labs(x = "Month", y = "Flux CO2",
         title = "Up and Downslope Transplant") +
    facet_wrap(Location ~ ., scales = "free",
               labeller = labeller(Location = Llabs)) +
    theme_bw() + theme(legend.position = "bottom")

```

```{r Less complicated CO2 analysis}

#just the transplant and location effects
slope <- aov(nFCO2 ~ Location * Origin,
           data = filterC_f_dat,
           na.action = na.omit)
summary(slope)

library(emmeans)
library(multcomp)

groups_CO2 <- emmeans(slope, ~ Origin|Location, adjust = "sidak")
cld(groups_CO2)

CO2_letters <- c("a","b","c",
                 "a","a","b",
                 "a","b","b")

f_dat %>%
  filter(Origin %in% c("g_low", "g_mid", "g_up")) %>%
  group_by(Location, Origin) %>%
  mutate(mean = mean(FCO2),
         sd = sd(FCO2),
         n = n()) %>%
  select(Location, Origin, mean, sd, n) %>%
  unique(.) %>%
  arrange(Location, Origin) -> CO2_fixedE

CO2_fixedE$letters <- CO2_letters

#elevation transplant
ggplot(CO2_fixedE, aes(Location, mean)) +
  geom_errorbar(aes(ymin = mean-sd, ymax = mean + sd),
                position = position_dodge2(width = 0.5)) +
  geom_point(aes(color = Origin),
             position = position_dodge2(width = 0.9),
             size = 6) +
  scale_color_discrete(name = "Soil Origin",
                      labels = Olabs) +
  scale_x_discrete(labels = Llabs) +
  labs(x = "\n Location", y = "Flux CO2",
       title = "Up and Downslope Transplant") +
  geom_text(aes(y=mean, label=letters),
            position = position_dodge2(width = 0.9)) +
  theme_bw() + theme(legend.position = "bottom")

```

## Soil Moisture

```{r moisture, message = FALSE, warning = FALSE}
require(tidyr)
f_dat %>%
  select(Location, Origin, FCO2, FCH4, SWC, TS) %>%
  pivot_longer(cols = c(FCO2, FCH4),
               names_to = "Flux_name",
               values_to = "Flux_value") -> longF

ggplot(longF[longF$Flux_value < 1000,], aes(SWC, Flux_value, group = Flux_name)) +
  geom_point(aes(color = Origin)) +
  geom_smooth(method = lm, formula = y ~ x, se = FALSE) +
  stat_poly_eq(formula = y ~ x,
               aes(label = paste(..p.value.label..,
                                 ..eq.label..,
                                 ..rr.label..,
                                 sep = "~~~"))) +
  scale_color_discrete(name = "Soil Origin",
                       labels = Olabs)
```


```{r Less complicated CO2 origin analysis}

f_dat %>%
  filter(Location == "g_low") -> filterC_f_dat2

#just the transplant and location effects
OriginC <- aov(nFCO2 ~ Origin,
           data = filterC_f_dat2,
           na.action = na.omit)
summary(OriginC)

groups_originCO2 <- emmeans(OriginC, ~ Origin, adjust = "sidak")
cld(groups_originCO2)



# #Variation within Lowland
# ggplot(f_dat[f_dat$Location == "g_low",], aes(month(timestamp), FCO2, fill = Origin)) +
#     geom_boxplot(aes(group = interaction(month(timestamp), Origin))) +
#       scale_fill_discrete(name = "Soil Origin",
#                       labels = Olabs) +
#     labs(x = "Month", y = "Flux CO2",
#          title = "Lowland Plot Soil Respiration") +
#     theme_bw() + theme(legend.position = "bottom")

CO2_Oletters <- c("A", "B", "AC", "AC", "C")

filterC_f_dat2%>%
  group_by(Origin) %>%
  mutate(mean = mean(FCO2),
         sd = sd(FCO2),
         n = n()) %>%
  select(Origin, mean, sd, n) %>%
  unique(.) %>%
  arrange(Origin) -> CO2_OriginE

CO2_OriginE$letters <- CO2_Oletters

#elevation transplant
ggplot(CO2_OriginE, aes(Origin, mean)) +
  geom_errorbar(aes(ymin = mean-sd, ymax = mean + sd),
                position = position_dodge2(width = 0.5)) +
  geom_point(aes(color = Origin),
             position = position_dodge2(width = 0.9),
             size = 6) +
  scale_color_discrete(name = "Soil Origin",
                      labels = Olabs) +
  scale_x_discrete(name = "Soil Origin",
                   labels = Olabs) +
  labs(y = "Flux CO2", title = "Seasonal Average within Lowland Plot") +
  geom_text(aes(y=mean, label=letters),
            position = position_dodge2(width = 0.9)) +
  theme_bw() + theme(legend.position = "none")
```
